<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trkey Keymap Configurator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Custom scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #3f3f46; /* zinc-700 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ef4444; /* red-500 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #dc2626; /* red-600 */
        }
        /* Ensure font is applied */
        body {
            font-family: sans-serif; /* Using generic sans-serif as Inter is not a standard web font */
        }
    </style>
</head>
<body class="bg-zinc-800 text-zinc-100 min-h-screen flex flex-col font-sans">
    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // Base keycodes for a 3x3 layout (standard for a macro pad)
        const BASE_KEYCODES = [
            "KC_Q", "KC_W", "KC_E",
            "KC_A", "KC_S", "KC_D",
            "KC_Z", "KC_X", "KC_C"
        ];

        // Default keymap for a 3x3 grid (Layer 0)
        const DEFAULT_KEYMAP = {
            "0": Array(3).fill(0).map(() =>
                Array(3).fill(0).map(() => ({ tap: { combo: "KC_NO", description: "Empty Key" } }))
            ),
        };

        // --- Translations (Expanded with new keys and French) ---
        const translations = {
            en: {
                appName: "Trkey Keymap Configurator",
                homeTab: "HOME",
                keymapTab: "KEYMAP",
                macroTab: "MACROS",
                settingsTab: "SETTINGS",
                mapUploadTab: "MAP UPLOAD",
                macrosTitle: "Macro Management",
                addMacro: "Add Macro",
                noMacros: "No macros defined yet. Click 'Add Macro' to create one.",
                macroName: "Macro Name",
                macroSequence: "Macro Sequence (comma-separated keycodes, e.g., KC_LWIN,KC_R)",
                macroSequencePlaceholder: "e.g., KC_A,KC_B,KC_C",
                saveMacro: "Save Macro",
                cancel: "Cancel",
                editMacro: "Edit Macro",
                deleteMacro: "Delete Macro",
                addShortcut: "Add Shortcut",
                editShortcut: "Edit Shortcut",
                shortcutName: "Shortcut Name",
                shortcutCombo: "Shortcut Combo (e.g., KC_A, KC_B, KC_C)",
                shortcutComboPlaceholder: "e.g., KC_LWIN,KC_R",
                dragAndDropKeys: "Drag and drop keys onto the grid.",
                orClickAndMap: "Or click a key on the grid, then click a shortcut below to assign.",
                emptyKey: "Empty Key",
                clearGrid: "Clear Grid",
                exportJson: "Export JSON",
                importJson: "Import JSON",
                language: "Language",
                theme: "Theme",
                light: "Light",
                dark: "Dark",
                connectDevice: "Connect to Micropad",
                disconnectDevice: "Disconnect Device",
                uploadKeymap: "Upload Keymap to Device",
                noDeviceConnectedTitle: "No Device Connected",
                noDeviceConnectedMessage: "Please connect to your Micropad first.",
                uploadSuccessfulTitle: "Upload Successful",
                uploadSuccessfulMessage: "The keymap has been successfully uploaded to your device.",
                uploadFailedTitle: "Upload Failed",
                uploadFailedMessage: "Failed to upload keymap: {error}",
                deviceConnected: "Device Connected",
                deviceDisconnected: "Device Disconnected",
                deleteMacroConfirmation: "Are you sure you want to delete this macro? This action cannot be undone.",
                currentKeymap: "Current Keymap",
                resetKeymap: "Reset Keymap",
                resetKeymapConfirmation: "Are you sure you want to reset the keymap to default? All custom mappings will be lost.",
                resetSuccessfulTitle: "Keymap Reset",
                resetSuccessfulMessage: "Keymap has been reset to default.",
                invalidJsonTitle: "Invalid JSON",
                invalidJsonMessage: "The uploaded file is not a valid JSON keymap.",
            },
            fr: {
                appName: "Configurateur de Keymap Trkey",
                homeTab: "ACCUEIL",
                keymapTab: "KEYMAP",
                macroTab: "MACROS",
                settingsTab: "RÉGLAGES",
                mapUploadTab: "TÉLÉCHARGER LA MAP",
                macrosTitle: "Gestion des Macros",
                addMacro: "Ajouter une Macro",
                noMacros: "Aucune macro définie pour l'instant. Cliquez sur 'Ajouter une Macro' pour en créer une.",
                macroName: "Nom de la Macro",
                macroSequence: "Séquence de Macro (codes de touche séparés par des virgules, ex: KC_LWIN,KC_R)",
                macroSequencePlaceholder: "ex: KC_A,KC_B,KC_C",
                saveMacro: "Enregistrer la Macro",
                cancel: "Annuler",
                editMacro: "Modifier la Macro",
                deleteMacro: "Supprimer la Macro",
                addShortcut: "Ajouter un Raccourci",
                editShortcut: "Modifier un Raccourci",
                shortcutName: "Nom du Raccourci",
                shortcutCombo: "Combinaison du Raccourci (ex: KC_A, KC_B, KC_C)",
                shortcutComboPlaceholder: "ex: KC_LWIN,KC_R",
                dragAndDropKeys: "Faites glisser les touches sur la grille.",
                orClickAndMap: "Ou cliquez sur une touche de la grille, puis cliquez sur un raccourci ci-dessous pour l'assigner.",
                emptyKey: "Touche Vide",
                clearGrid: "Effacer la Grille",
                exportJson: "Exporter JSON",
                importJson: "Importer JSON",
                language: "Langue",
                theme: "Thème",
                light: "Clair",
                dark: "Sombre",
                connectDevice: "Connecter au Micropad",
                disconnectDevice: "Déconnecter l'Appareil",
                uploadKeymap: "Télécharger Keymap vers l'Appareil",
                noDeviceConnectedTitle: "Aucun Appareil Connecté",
                noDeviceConnectedMessage: "Veuillez d'abord vous connecter à votre Micropad.",
                uploadSuccessfulTitle: "Téléchargement Réussi",
                uploadSuccessfulMessage: "Le keymap a été téléchargé avec succès sur votre appareil.",
                uploadFailedTitle: "Échec du Téléchargement",
                uploadFailedMessage: "Échec du téléchargement du keymap : {error}",
                deviceConnected: "Appareil Connecté",
                deviceDisconnected: "Appareil Déconnecté",
                deleteMacroConfirmation: "Êtes-vous sûr de vouloir supprimer cette macro ? Cette action est irréversible.",
                currentKeymap: "Keymap Actuel",
                resetKeymap: "Réinitialiser Keymap",
                resetKeymapConfirmation: "Êtes-vous sûr de vouloir réinitialiser le keymap par défaut ? Toutes les associations personnalisées seront perdues.",
                resetSuccessfulTitle: "Keymap Réinitialisé",
                resetSuccessfulMessage: "Le keymap a été réinitialisé par défaut.",
                invalidJsonTitle: "JSON Invalide",
                invalidJsonMessage: "Le fichier téléchargé n'est pas un keymap JSON valide.",
            }
        };

        // Keycode mapping (simplified example)
        const KEYCODES = [
            // Basic keys
            { code: "KC_A", description: "A" }, { code: "KC_B", description: "B" }, { code: "KC_C", description: "C" },
            { code: "KC_D", description: "D" }, { code: "KC_E", description: "E" }, { code: "KC_F", description: "F" },
            { code: "KC_G", description: "G" }, { code: "KC_H", description: "H" }, { code: "KC_I", description: "I" },
            { code: "KC_J", description: "J" }, { code: "KC_K", description: "K" }, { code: "KC_L", description: "L" },
            { code: "KC_M", description: "M" }, { code: "KC_N", description: "N" }, { code: "KC_O", description: "O" },
            { code: "KC_P", description: "P" }, { code: "KC_Q", description: "Q" }, { code: "KC_R", description: "R" },
            { code: "KC_S", description: "S" }, { code: "KC_T", description: "T" }, { code: "KC_U", description: "U" },
            { code: "KC_V", description: "V" }, { code: "KC_W", description: "W" }, { code: "KC_X", description: "X" },
            { code: "KC_Y", description: "Y" }, { code: "KC_Z", description: "Z" },
            // Numbers
            { code: "KC_1", description: "1" }, { code: "KC_2", description: "2" }, { code: "KC_3", description: "3" },
            { code: "KC_4", description: "4" }, { code: "KC_5", description: "5" }, { code: "KC_6", description: "6" },
            { code: "KC_7", description: "7" }, { code: "KC_8", description: "8" }, { code: "KC_9", description: "9" },
            { code: "KC_0", description: "0" },
            // Modifiers
            { code: "KC_LCTL", description: "Left Ctrl" }, { code: "KC_LSFT", description: "Left Shift" },
            { code: "KC_LALT", description: "Left Alt" }, { code: "KC_LWIN", description: "Left GUI" },
            { code: "KC_RCTL", description: "Right Ctrl" }, { code: "KC_RSFT", description: "Right Shift" },
            { code: "KC_RALT", description: "Right Alt" }, { code: "KC_RWIN", description: "Right GUI" },
            // Function keys
            { code: "KC_F1", description: "F1" }, { code: "KC_F2", description: "F2" }, { code: "KC_F3", description: "F3" },
            { code: "KC_F4", description: "F4" }, { code: "KC_F5", description: "F5" }, { code: "KC_F6", description: "F6" },
            { code: "KC_F7", description: "F7" }, { code: "KC_F8", description: "F8" }, { code: "KC_F9", description: "F9" },
            { code: "KC_F10", description: "F10" }, { code: "KC_F11", description: "F11" }, { code: "KC_F12", description: "F12" },
            // Special characters
            { code: "KC_ENT", description: "Enter" }, { code: "KC_ESC", description: "Escape" },
            { code: "KC_BSPC", description: "Backspace" }, { code: "KC_TAB", description: "Tab" },
            { code: "KC_SPC", description: "Space" }, { code: "KC_MINS", description: "-" },
            { code: "KC_EQL", description: "=" }, { code: "KC_LBRC", description: "[" },
            { code: "KC_RBRC", description: "]" }, { code: "KC_BSLS", description: "\\" },
            { code: "KC_SCLN", description: ";" }, { code: "KC_QUOT", description: "'" },
            { code: "KC_GRV", description: "`" }, { code: "KC_COMM", description: "," },
            { code: "KC_DOT", description: "." }, { code: "KC_SLSH", description: "/" },
            // Arrow keys
            { code: "KC_LEFT", description: "Left Arrow" }, { code: "KC_RGHT", description: "Right Arrow" },
            { code: "KC_UP", description: "Up Arrow" }, { code: "KC_DOWN", description: "Down Arrow" },
            // Media keys
            { code: "KC_MPRV", description: "Media Prev" }, { code: "KC_MNXT", description: "Media Next" },
            { code: "KC_MUTE", description: "Mute" }, { code: "KC_VOLU", description: "Volume Up" },
            { code: "KC_VOLD", description: "Volume Down" },
            // Other
            { code: "KC_NO", description: "No Action" } // For unassigned keys
        ];


        // Components (Modal, MacroFormModal, ConfirmationModal, AddShortcutModal, KeyDisplay, KeyPool) would be here
        // (omitted for brevity, assume they are defined as in previous versions)

        // --- Modals ---
        const Modal = ({ show, onClose, title, message, language, translations }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-zinc-700 p-6 rounded-lg shadow-xl max-w-sm w-full border border-red-500">
                        <h2 className="text-xl font-bold text-red-400 mb-4">{title}</h2>
                        <p className="text-zinc-200 mb-6">{message}</p>
                        <div className="flex justify-end">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                            >
                                OK
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const MacroFormModal = ({ show, onClose, onSave, macro, language }) => {
            const [name, setName] = useState('');
            const [sequence, setSequence] = useState('');

            useEffect(() => {
                if (macro) {
                    setName(macro.name);
                    setSequence(macro.sequence.join(','));
                } else {
                    setName('');
                    setSequence('');
                }
            }, [macro, show]);

            const handleSubmit = () => {
                if (name && sequence) {
                    onSave({
                        id: macro ? macro.id : Date.now(),
                        name,
                        sequence: sequence.split(',').map(s => s.trim().toUpperCase()).filter(s => s)
                    });
                    onClose();
                } else {
                    // Replaced alert with custom modal
                    setModalContent({
                        title: "Input Error",
                        message: "Please fill in all fields for the macro."
                    });
                    setShowModal(true);
                }
            };

            return (
                <div className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 ${show ? '' : 'hidden'}`}>
                    <div className="bg-zinc-700 p-6 rounded-lg shadow-xl max-w-md w-full border border-red-500">
                        <h2 className="text-xl font-bold text-red-400 mb-4">{macro ? translations.editMacro[language] : translations.addMacro[language]}</h2>
                        <div className="mb-4">
                            <label htmlFor="macroName" className="block text-zinc-200 text-sm font-bold mb-2">
                                {translations.macroName[language]}
                            </label>
                            <input
                                type="text"
                                id="macroName"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-zinc-700 leading-tight focus:outline-none focus:shadow-outline bg-zinc-300"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder={translations.macroName[language]}
                            />
                        </div>
                        <div className="mb-6">
                            <label htmlFor="macroSequence" className="block text-zinc-200 text-sm font-bold mb-2">
                                {translations.macroSequence[language]}
                            </label>
                            <input
                                type="text"
                                id="macroSequence"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-zinc-700 leading-tight focus:outline-none focus:shadow-outline bg-zinc-300"
                                value={sequence}
                                onChange={(e) => setSequence(e.target.value)}
                                placeholder={translations.macroSequencePlaceholder[language]}
                            />
                        </div>
                        <div className="flex justify-end space-x-2">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 bg-zinc-500 text-white rounded hover:bg-zinc-600 transition-colors"
                            >
                                {translations.cancel[language]}
                            </button>
                            <button
                                onClick={handleSubmit}
                                className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                            >
                                {translations.saveMacro[language]}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmationModal = ({ show, onClose, onConfirm, message, language }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-zinc-700 p-6 rounded-lg shadow-xl max-w-sm w-full border border-red-500">
                        <h2 className="text-xl font-bold text-red-400 mb-4">Confirmation</h2>
                        <p className="text-zinc-200 mb-6">{message}</p>
                        <div className="flex justify-end space-x-2">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 bg-zinc-500 text-white rounded hover:bg-zinc-600 transition-colors"
                            >
                                {translations.cancel[language]}
                            </button>
                            <button
                                onClick={onConfirm}
                                className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                            >
                                {translations.deleteMacro[language]}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddShortcutModal = ({ show, onClose, onSave, shortcut, language }) => {
            const [name, setName] = useState('');
            const [combo, setCombo] = useState('');

            useEffect(() => {
                if (shortcut) {
                    setName(shortcut.name);
                    setCombo(shortcut.combo.join(','));
                } else {
                    setName('');
                    setCombo('');
                }
            }, [shortcut, show]);

            const handleSubmit = () => {
                if (name && combo) {
                    onSave({
                        id: shortcut ? shortcut.id : Date.now(),
                        name,
                        combo: combo.split(',').map(s => s.trim().toUpperCase()).filter(s => s)
                    });
                    onClose();
                } else {
                    // Replaced alert with custom modal
                    setModalContent({
                        title: "Input Error",
                        message: "Please fill in all fields for the shortcut."
                    });
                    setShowModal(true);
                }
            };

            return (
                <div className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 ${show ? '' : 'hidden'}`}>
                    <div className="bg-zinc-700 p-6 rounded-lg shadow-xl max-w-md w-full border border-red-500">
                        <h2 className="text-xl font-bold text-red-400 mb-4">{shortcut ? translations.editShortcut[language] : translations.addShortcut[language]}</h2>
                        <div className="mb-4">
                            <label htmlFor="shortcutName" className="block text-zinc-200 text-sm font-bold mb-2">
                                {translations.shortcutName[language]}
                            </label>
                            <input
                                type="text"
                                id="shortcutName"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-zinc-700 leading-tight focus:outline-none focus:shadow-outline bg-zinc-300"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder={translations.shortcutName[language]}
                            />
                        </div>
                        <div className="mb-6">
                            <label htmlFor="shortcutCombo" className="block text-zinc-200 text-sm font-bold mb-2">
                                {translations.shortcutCombo[language]}
                            </label>
                            <input
                                type="text"
                                id="shortcutCombo"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-zinc-700 leading-tight focus:outline-none focus:shadow-outline bg-zinc-300"
                                value={combo}
                                onChange={(e) => setCombo(e.target.value)}
                                placeholder={translations.shortcutComboPlaceholder[language]}
                            />
                        </div>
                        <div className="flex justify-end space-x-2">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 bg-zinc-500 text-white rounded hover:bg-zinc-600 transition-colors"
                            >
                                {translations.cancel[language]}
                            </button>
                            <button
                                onClick={handleSubmit}
                                className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                            >
                                {translations.saveMacro[language]} {/* Reusing saveMacro for now */}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const KeyDisplay = ({ keyCode, description, onClick, onDragStart, className = "" }) => (
            <div
                className={`flex flex-col items-center justify-center p-2 rounded-lg cursor-pointer select-none text-center
                            ${keyCode === "KC_NO" ? "bg-zinc-600 text-zinc-400" : "bg-zinc-700 hover:bg-zinc-600 text-zinc-100"}
                            ${className}`}
                onClick={onClick}
                draggable="true"
                onDragStart={(e) => onDragStart(e, { combo: keyCode, description })}
            >
                <div className="font-semibold text-xs truncate w-full px-1">{description}</div>
                <div className="text-xs text-red-400 truncate w-full px-1">{keyCode}</div>
            </div>
        );

        const KeyPool = ({ keys, onDragStart, onAddShortcut, onEditShortcut, onDeleteShortcut, language }) => (
            <div className="bg-zinc-700 p-4 rounded-lg shadow-inner overflow-y-auto custom-scrollbar h-full">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-bold text-red-400">{translations.currentKeymap[language]}</h3>
                    <button
                        onClick={onAddShortcut}
                        className="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition-colors"
                    >
                        {translations.addShortcut[language]}
                    </button>
                </div>
                <div className="grid grid-cols-3 gap-2">
                    {keys.map((key, index) => (
                        <div key={key.id || index} className="relative group">
                            <KeyDisplay
                                keyCode={key.combo ? key.combo.join(',') : key.code}
                                description={key.name || key.description}
                                onDragStart={(e, data) => onDragStart(e, {
                                    combo: key.combo || [key.code],
                                    description: key.name || key.description
                                })}
                            />
                            {key.id && ( // Only show edit/delete for custom shortcuts/macros
                                <div className="absolute top-0 right-0 mt-1 mr-1 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button
                                        onClick={() => onEditShortcut(key)}
                                        className="p-1 bg-blue-500 text-white rounded-full text-xs hover:bg-blue-600"
                                        title="Edit"
                                    >
                                        ✏️
                                    </button>
                                    <button
                                        onClick={() => onDeleteShortcut(key.id)}
                                        className="p-1 bg-red-500 text-white rounded-full text-xs hover:bg-red-600"
                                        title="Delete"
                                    >
                                        🗑️
                                    </button>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        );


        // --- App Component ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('keymap'); // 'home', 'keymap', 'macros', 'settings', 'map-upload'
            const [keymap, setKeymap] = useState(() => {
                const savedKeymap = localStorage.getItem('trkeyKeymap');
                return savedKeymap ? JSON.parse(savedKeymap) : DEFAULT_KEYMAP;
            });
            const [macros, setMacros] = useState(() => {
                const savedMacros = localStorage.getItem('trkeyMacros');
                return savedMacros ? JSON.parse(savedMacros) : [];
            });
            const [shortcuts, setShortcuts] = useState(() => {
                const savedShortcuts = localStorage.getItem('trkeyShortcuts');
                return savedShortcuts ? JSON.parse(savedShortcuts) : [];
            });
            const [language, setLanguage] = useState(localStorage.getItem('trkeyLanguage') || 'en');
            const [theme, setTheme] = useState(localStorage.getItem('trkeyTheme') || 'dark'); // 'dark' or 'light'

            const [draggedKey, setDraggedKey] = useState(null);
            const [selectedGridKey, setSelectedGridKey] = useState(null); // {row, col} of selected key for click-to-map

            const [showModal, setShowModal] = useState(false);
            const [modalContent, setModalContent] = useState({ title: '', message: '' });

            const [showMacroFormModal, setShowMacroFormModal] = useState(false);
            const [editingMacro, setEditingMacro] = useState(null);

            const [showConfirmationModal, setShowConfirmationModal] = useState(false);
            const [macroToDeleteId, setMacroToDeleteId] = useState(null);
            const [showAddShortcutModal, setShowAddShortcutModal] = useState(false);
            const [editingShortcut, setEditingShortcut] = useState(null);

            const [connectedPort, setConnectedPort] = useState(null);
            const [statusMessage, setStatusMessage] = useState("Not Connected");


            // Persist state to localStorage
            useEffect(() => {
                localStorage.setItem('trkeyKeymap', JSON.stringify(keymap));
            }, [keymap]);

            useEffect(() => {
                localStorage.setItem('trkeyMacros', JSON.stringify(macros));
            }, [macros]);

            useEffect(() => {
                localStorage.setItem('trkeyShortcuts', JSON.stringify(shortcuts));
            }, [shortcuts]);

            useEffect(() => {
                localStorage.setItem('trkeyLanguage', language);
                localStorage.setItem('trkeyTheme', theme);
                document.body.className = `${theme === 'dark' ? 'bg-zinc-800 text-zinc-100' : 'bg-zinc-100 text-zinc-800'} min-h-screen flex flex-col font-sans`;
            }, [language, theme]);


            // --- Macro Handlers ---
            const handleAddMacroClick = () => {
                setEditingMacro(null);
                setShowMacroFormModal(true);
            };

            const handleSaveMacro = (newMacro) => {
                setMacros(prevMacros => {
                    const existingIndex = prevMacros.findIndex(m => m.id === newMacro.id);
                    if (existingIndex > -1) {
                        return prevMacros.map(m => m.id === newMacro.id ? newMacro : m);
                    }
                    return [...prevMacros, newMacro];
                });
            };

            const handleEditMacro = (macro) => {
                setEditingMacro(macro);
                setShowMacroFormModal(true);
            };

            const handleDeleteMacro = (id) => {
                setMacroToDeleteId(id);
                setShowConfirmationModal(true);
            };

            const confirmDeleteMacro = () => {
                setMacros(prevMacros => prevMacros.filter(m => m.id !== macroToDeleteId));
                setShowConfirmationModal(false);
                setMacroToDeleteId(null);
            };

            // --- Shortcut Handlers ---
            const handleAddShortcutClick = () => {
                setEditingShortcut(null);
                setShowAddShortcutModal(true);
            };

            const handleSaveNewShortcut = (newShortcut) => {
                setShortcuts(prevShortcuts => {
                    const existingIndex = prevShortcuts.findIndex(s => s.id === newShortcut.id);
                    if (existingIndex > -1) {
                        return prevShortcuts.map(s => s.id === newShortcut.id ? newShortcut : s);
                    }
                    return [...prevShortcuts, newShortcut];
                });
            };

            const handleEditShortcut = (shortcut) => {
                setEditingShortcut(shortcut);
                setShowAddShortcutModal(true);
            };

            const handleDeleteShortcut = (id) => {
                setShortcuts(prevShortcuts => prevShortcuts.filter(s => s.id !== id));
            };


            // --- Drag & Drop Handlers ---
            const handleDragStart = (e, keyData) => {
                setDraggedKey(keyData);
            };

            const handleDragOver = (e) => {
                e.preventDefault(); // Allows us to drop
            };

            const handleDrop = (r, c) => {
                if (draggedKey) {
                    setKeymap(prevKeymap => {
                        const newKeymap = { ...prevKeymap };
                        newKeymap["0"] = newKeymap["0"].map((row, rowIndex) =>
                            row.map((cell, colIndex) => {
                                if (rowIndex === r && colIndex === c) {
                                    return {
                                        tap: {
                                            combo: draggedKey.combo,
                                            description: draggedKey.description
                                        },
                                        // future: hold, combo, etc.
                                    };
                                }
                                return cell;
                            })
                        );
                        return newKeymap;
                    });
                    setDraggedKey(null);
                    setSelectedGridKey(null); // Clear selection after drop
                }
            };

            const handleKeyClick = (r, c) => {
                setSelectedGridKey({ r, c });
            };

            const handlePoolKeyClick = (keyData) => {
                if (selectedGridKey) {
                    const { r, c } = selectedGridKey;
                    setKeymap(prevKeymap => {
                        const newKeymap = { ...prevKeymap };
                        newKeymap["0"] = newKeymap["0"].map((row, rowIndex) =>
                            row.map((cell, colIndex) => {
                                if (rowIndex === r && colIndex === c) {
                                    return {
                                        tap: {
                                            combo: keyData.combo,
                                            description: keyData.description
                                        },
                                    };
                                }
                                return cell;
                            })
                        );
                        return newKeymap;
                    });
                    setSelectedGridKey(null); // Clear selection after click-to-map
                }
            };


            // --- Grid Actions ---
            const handleClearGrid = () => {
                setKeymap(DEFAULT_KEYMAP);
            };

            const handleResetKeymap = () => {
                setModalContent({
                    title: translations.resetKeymap[language],
                    message: translations.resetKeymapConfirmation[language]
                });
                setShowConfirmationModal(true); // Reusing confirmation modal
                setMacroToDeleteId('RESET_KEYMAP'); // Use a special ID to indicate reset
            };

            const confirmResetKeymap = () => {
                if (macroToDeleteId === 'RESET_KEYMAP') {
                    setKeymap(DEFAULT_KEYMAP);
                    setModalContent({
                        title: translations.resetSuccessfulTitle[language],
                        message: translations.resetSuccessfulMessage[language]
                    });
                    setShowModal(true); // Use generic success modal
                    setShowConfirmationModal(false);
                    setMacroToDeleteId(null);
                } else {
                    confirmDeleteMacro(); // Fallback for actual macro deletion
                }
            };

            // --- Export/Import JSON (still supporting JSON for file operations) ---
            const handleExportJson = () => {
                const exportData = {
                    keymap: keymap,
                    macros: macros,
                    shortcuts: shortcuts
                };
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'trkey_config.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleImportJson = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.keymap) setKeymap(importedData.keymap);
                        if (importedData.macros) setMacros(importedData.macros);
                        if (importedData.shortcuts) setShortcuts(importedData.shortcuts);
                        setModalContent({
                            title: "Import Successful",
                            message: "Keymap, macros, and shortcuts imported successfully."
                        });
                        setShowModal(true);
                    } catch (error) {
                        setModalContent({
                            title: translations.invalidJsonTitle[language],
                            message: translations.invalidJsonMessage[language] + ` (${error.message})`
                        });
                        setShowModal(true);
                    }
                };
                reader.readAsText(file);
            };

            // --- Serial Port Communication (Web Serial API) ---
            let portReader = null; // To store the reader
            let inputDone = null; // Promise resolvers for reader
            let outputDone = null; // Promise resolvers for writer
            let inputStream = null;
            let outputStream = null;

            const connectToDevice = async () => {
                try {
                    // Request a serial port
                    const port = await navigator.serial.requestPort();

                    // Open the port
                    await port.open({ baudRate: 500000 }); // Must match device firmware

                    // Get streams
                    const textDecoder = new TextDecoderStream();
                    inputDone = port.readable.pipeTo(textDecoder.writable);
                    inputStream = textDecoder.readable.getReader();

                    const textEncoder = new TextEncoderStream();
                    outputDone = textEncoder.readable.pipeTo(port.writable);
                    outputStream = textEncoder.writable.getWriter();

                    setConnectedPort(port);
                    setStatusMessage(translations.deviceConnected[language]);
                    setModalContent({
                        title: translations.deviceConnected[language],
                        message: "Successfully connected to your Micropad!"
                    });
                    setShowModal(true);

                    // Start listening for data
                    readLoop(inputStream);

                } catch (err) {
                    console.error("Error connecting to device:", err);
                    setStatusMessage(`Connection Failed: ${err.message}`);
                    setModalContent({
                        title: "Connection Failed",
                        message: `Could not connect to device: ${err.message}`
                    });
                    setShowModal(true);
                }
            };

            const disconnectDevice = async () => {
                if (connectedPort) {
                    try {
                        // Close the streams
                        if (inputStream) {
                            await inputStream.cancel();
                            await inputDone.catch(() => {}); // Catch any error during cancellation
                        }
                        if (outputStream) {
                            await outputStream.close();
                            await outputDone;
                        }

                        // Close the port
                        await connectedPort.close();
                        setConnectedPort(null);
                        setStatusMessage(translations.deviceDisconnected[language]);
                        setModalContent({
                            title: translations.deviceDisconnected[language],
                            message: "Disconnected from Micropad."
                        });
                        setShowModal(true);
                    } catch (err) {
                        console.error("Error disconnecting device:", err);
                        setStatusMessage(`Disconnection Failed: ${err.message}`);
                        setModalContent({
                            title: "Disconnection Failed",
                            message: `Error disconnecting: ${err.message}`
                        });
                        setShowModal(true);
                    }
                }
            };

            // Read data from the serial port
            const readLoop = async (reader) => {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        reader.releaseLock();
                        break;
                    }
                    if (value) {
                        console.log("Received from device:", value.trim());
                        // You can process incoming messages here if needed (e.g., status updates)
                    }
                }
            };

            // --- New Text Keymap Functions ---
            const buildTextKeymap = () => {
                let layerString = "L0:"; // Indicates layer 0
                for (let r = 0; r < 3; r++) {
                    let row = [];
                    for (let c = 0; c < 3; c++) {
                        // Ensure keymap["0"] exists and has the correct structure
                        const cell = (keymap["0"] && keymap["0"][r] && keymap["0"][r][c])
                                     ? keymap["0"][r][c]
                                     : { tap: { combo: "KC_NO" } }; // Default if structure is missing

                        // Get the combo, or default to "KC_NO" if not defined
                        const comboValue = Array.isArray(cell.tap?.combo)
                                            ? cell.tap.combo.join('+') // Join combo arrays for text format
                                            : cell.tap?.combo || "KC_NO";
                        row.push(comboValue);
                    }
                    layerString += row.join(",");
                    if (r < 2) layerString += ";"; // Separate rows with ;
                }
                return layerString;
            };

            const uploadKeymapText = async () => {
                if (!connectedPort) {
                    setModalContent({
                        title: translations.noDeviceConnectedTitle[language],
                        message: translations.noDeviceConnectedMessage[language]
                    });
                    setShowModal(true);
                    return;
                }

                try {
                    setStatusMessage("Uploading keymap (text format)...");

                    // Ensure port is open (redundant if already open by connectToDevice, but good for safety)
                    if (connectedPort.readable === null && connectedPort.writable === null) {
                        await connectedPort.open({ baudRate: 500000 });
                    }

                    const writer = connectedPort.writable.getWriter();
                    const encoder = new TextEncoder();
                    const mapText = buildTextKeymap();

                    // Send the text keymap followed by a newline
                    await writer.write(encoder.encode(mapText + "\n"));
                    writer.releaseLock();

                    console.log("✅ Uploaded Text Keymap:", mapText);
                    setStatusMessage("Keymap uploaded successfully!");
                    setModalContent({
                        title: translations.uploadSuccessfulTitle[language],
                        message: translations.uploadSuccessfulMessage[language]
                    });
                } catch (err) {
                    console.error("❌ Upload failed:", err);
                    setStatusMessage(`Upload Failed: ${err.message}`);
                    setModalContent({
                        title: translations.uploadFailedTitle[language],
                        message: translations.uploadFailedMessage[language].replace('{error}', err.message)
                    });
                } finally {
                    setShowModal(true);
                }
            };


            // Combine standard keycodes and custom shortcuts/macros for the key pool
            const availableKeys = React.useMemo(() => {
                const standard = KEYCODES.map(k => ({ ...k, combo: [k.code] })); // Ensure combo is an array
                const customMacros = macros.map(m => ({ id: m.id, name: m.name, combo: m.sequence, isMacro: true }));
                const customShortcuts = shortcuts.map(s => ({ id: s.id, name: s.name, combo: s.combo, isShortcut: true }));
                return [...standard, ...customMacros, ...customShortcuts];
            }, [macros, shortcuts]);

            // --- Render Logic ---
            return (
                <div className="flex flex-col h-full">
                    {/* Navigation */}
                    <nav className="bg-zinc-900 p-4 shadow-md flex justify-between items-center">
                        <h1 className="text-2xl font-bold text-red-500">{translations.appName[language]}</h1>
                        <div className="flex space-x-4">
                            <button onClick={() => setActiveTab('home')} className={`px-4 py-2 rounded-md ${activeTab === 'home' ? 'bg-red-600' : 'bg-zinc-700 hover:bg-zinc-600'} text-white transition-colors`}>
                                {translations.homeTab[language]}
                            </button>
                            <button onClick={() => setActiveTab('keymap')} className={`px-4 py-2 rounded-md ${activeTab === 'keymap' ? 'bg-red-600' : 'bg-zinc-700 hover:bg-zinc-600'} text-white transition-colors`}>
                                {translations.keymapTab[language]}
                            </button>
                            <button onClick={() => setActiveTab('macros')} className={`px-4 py-2 rounded-md ${activeTab === 'macros' ? 'bg-red-600' : 'bg-zinc-700 hover:bg-zinc-600'} text-white transition-colors`}>
                                {translations.macroTab[language]}
                            </button>
                            <button onClick={() => setActiveTab('settings')} className={`px-4 py-2 rounded-md ${activeTab === 'settings' ? 'bg-red-600' : 'bg-zinc-700 hover:bg-zinc-600'} text-white transition-colors`}>
                                {translations.settingsTab[language]}
                            </button>
                            <button onClick={() => setActiveTab('map-upload')} className={`px-4 py-2 rounded-md ${activeTab === 'map-upload' ? 'bg-red-600' : 'bg-zinc-700 hover:bg-zinc-600'} text-white transition-colors`}>
                                {translations.mapUploadTab[language]}
                            </button>
                        </div>
                    </nav>

                    {/* Main Content Area */}
                    <div className="flex-grow p-6">
                        {activeTab === 'home' && (
                            <div className="text-center p-8 bg-zinc-700 rounded-lg shadow-lg">
                                <h2 className="text-3xl font-bold text-red-400 mb-4">{translations.appName[language]}</h2>
                                <p className="text-lg text-zinc-200 mb-4">Welcome to the Trkey Keymap Configurator!</p>
                                <p className="text-zinc-300">
                                    This tool allows you to easily create and manage custom keymaps for your Trkey keyboard.
                                    Navigate through the tabs above to define your key assignments, manage macros, and upload your configuration to the device.
                                </p>
                            </div>
                        )}

                        {activeTab === 'keymap' && (
                            <div className="flex flex-col lg:flex-row h-full lg:space-x-6 space-y-6 lg:space-y-0">
                                {/* Keymap Grid */}
                                <div className="flex-1 bg-zinc-700 p-6 rounded-lg shadow-lg flex flex-col items-center">
                                    <h2 className="text-2xl font-bold text-red-400 mb-4">{translations.keymapTab[language]}</h2>
                                    <p className="text-zinc-300 mb-4">{translations.dragAndDropKeys[language]}</p>
                                    <p className="text-zinc-300 mb-6">{translations.orClickAndMap[language]}</p>
                                    <div className="grid grid-cols-3 gap-4 p-4 bg-zinc-900 rounded-lg shadow-inner">
                                        {keymap["0"].map((row, rowIndex) => (
                                            row.map((cell, colIndex) => (
                                                <div
                                                    key={`${rowIndex}-${colIndex}`}
                                                    className={`w-24 h-24 border-2 rounded-lg flex items-center justify-center
                                                                ${selectedGridKey?.r === rowIndex && selectedGridKey?.c === colIndex ? 'border-red-500' : 'border-zinc-500'}
                                                                ${cell.tap?.combo === "KC_NO" ? 'bg-zinc-600' : 'bg-zinc-800'}
                                                                transition-all duration-100`}
                                                    onDragOver={handleDragOver}
                                                    onDrop={() => handleDrop(rowIndex, colIndex)}
                                                    onClick={() => handleKeyClick(rowIndex, colIndex)}
                                                >
                                                    <KeyDisplay
                                                        keyCode={Array.isArray(cell.tap?.combo) ? cell.tap.combo.join(',') : cell.tap?.combo || "KC_NO"}
                                                        description={cell.tap?.description || translations.emptyKey[language]}
                                                        onDragStart={(e, data) => handleDragStart(e, data)}
                                                        onClick={() => handleKeyClick(rowIndex, colIndex)} // Allow re-selecting a key on grid
                                                        className="w-full h-full text-sm"
                                                    />
                                                </div>
                                            ))
                                        ))}
                                    </div>
                                    <div className="mt-6 flex space-x-4">
                                        <button
                                            onClick={handleClearGrid}
                                            className="px-6 py-2 bg-zinc-600 text-white rounded hover:bg-zinc-700 transition-colors"
                                        >
                                            {translations.clearGrid[language]}
                                        </button>
                                        <button
                                            onClick={handleResetKeymap}
                                            className="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                                        >
                                            {translations.resetKeymap[language]}
                                        </button>
                                    </div>
                                </div>

                                {/* Key Pool (Standard + Custom Shortcuts/Macros) */}
                                <div className="flex-1 min-h-[300px] lg:min-h-full">
                                    <KeyPool
                                        keys={availableKeys}
                                        onDragStart={handleDragStart}
                                        onAddShortcut={handleAddShortcutClick}
                                        onEditShortcut={handleEditShortcut}
                                        onDeleteShortcut={handleDeleteShortcut}
                                        language={language}
                                    />
                                </div>
                            </div>
                        )}

                        {activeTab === 'macros' && (
                            <div className="bg-zinc-700 p-6 rounded-lg shadow-lg max-w-2xl mx-auto">
                                <h2 className="text-2xl font-bold text-red-400 mb-4">{translations.macrosTitle[language]}</h2>
                                <button
                                    onClick={handleAddMacroClick}
                                    className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors mb-6"
                                >
                                    {translations.addMacro[language]}
                                </button>
                                {macros.length === 0 ? (
                                    <p className="text-zinc-300">{translations.noMacros[language]}</p>
                                ) : (
                                    <div className="space-y-4">
                                        {macros.map(macro => (
                                            <div key={macro.id} className="bg-zinc-600 p-4 rounded-lg flex justify-between items-center shadow">
                                                <div>
                                                    <h3 className="text-lg font-semibold text-zinc-100">{macro.name}</h3>
                                                    <p className="text-sm text-zinc-300">{macro.sequence.join(', ')}</p>
                                                </div>
                                                <div className="flex space-x-2">
                                                    <button
                                                        onClick={() => handleEditMacro(macro)}
                                                        className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm"
                                                    >
                                                        {translations.editMacro[language]}
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteMacro(macro.id)}
                                                        className="px-3 py-1 bg-red-700 text-white rounded hover:bg-red-800 transition-colors text-sm"
                                                    >
                                                        {translations.deleteMacro[language]}
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="bg-zinc-700 p-6 rounded-lg shadow-lg max-w-xl mx-auto">
                                <h2 className="text-2xl font-bold text-red-400 mb-4">{translations.settingsTab[language]}</h2>
                                <div className="mb-4">
                                    <label htmlFor="language-select" className="block text-zinc-200 text-sm font-bold mb-2">
                                        {translations.language[language]}:
                                    </label>
                                    <select
                                        id="language-select"
                                        value={language}
                                        onChange={(e) => setLanguage(e.target.value)}
                                        className="block w-full py-2 px-3 border border-zinc-500 bg-zinc-600 text-zinc-100 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm"
                                    >
                                        <option value="en">English</option>
                                        <option value="fr">Français</option>
                                    </select>
                                </div>
                                <div className="mb-4">
                                    <label htmlFor="theme-select" className="block text-zinc-200 text-sm font-bold mb-2">
                                        {translations.theme[language]}:
                                    </label>
                                    <select
                                        id="theme-select"
                                        value={theme}
                                        onChange={(e) => setTheme(e.target.value)}
                                        className="block w-full py-2 px-3 border border-zinc-500 bg-zinc-600 text-zinc-100 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm"
                                    >
                                        <option value="dark">{translations.dark[language]}</option>
                                        <option value="light">{translations.light[language]}</option>
                                    </select>
                                </div>
                                <div className="mt-6 space-y-4">
                                    <div>
                                        <button
                                            onClick={handleExportJson}
                                            className="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                                        >
                                            {translations.exportJson[language]}
                                        </button>
                                        <p className="text-zinc-400 text-sm mt-1">Export your current keymap, macros, and shortcuts to a JSON file.</p>
                                    </div>
                                    <div>
                                        <label htmlFor="import-json" className="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors cursor-pointer">
                                            {translations.importJson[language]}
                                        </label>
                                        <input
                                            id="import-json"
                                            type="file"
                                            accept=".json"
                                            onChange={handleImportJson}
                                            className="hidden"
                                        />
                                        <p className="text-zinc-400 text-sm mt-1">Import keymap, macros, and shortcuts from a JSON file.</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'map-upload' && (
                            <div className="bg-zinc-700 p-6 rounded-lg shadow-lg max-w-xl mx-auto text-center">
                                <h2 className="text-2xl font-bold text-red-400 mb-4">{translations.mapUploadTab[language]}</h2>
                                <p className="text-zinc-300 mb-4">
                                    Connect your Trkey Micropad and upload the configured keymap.
                                </p>
                                <div className="mb-6">
                                    <p className="text-lg font-semibold text-zinc-200">{statusMessage}</p>
                                </div>
                                <div className="flex flex-col space-y-4">
                                    <button
                                        onClick={connectedPort ? disconnectDevice : connectToDevice}
                                        className={`px-6 py-3 rounded-md transition-colors ${connectedPort ? 'bg-zinc-600 hover:bg-zinc-700' : 'bg-red-500 hover:bg-red-600'} text-white text-lg`}
                                    >
                                        {connectedPort ? translations.disconnectDevice[language] : translations.connectDevice[language]}
                                    </button>
                                    <button
                                        onClick={uploadKeymapText} // Call the new text upload function
                                        disabled={!connectedPort}
                                        className={`px-6 py-3 rounded-md transition-colors ${connectedPort ? 'bg-red-500 hover:bg-red-600' : 'bg-zinc-600 cursor-not-allowed'} text-white text-lg`}
                                    >
                                        {translations.uploadKeymap[language]}
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Modal for generic messages */}
                    <Modal
                        show={showModal}
                        onClose={() => setShowModal(false)}
                        title={modalContent.title}
                        message={modalContent.message}
                        language={language}
                        translations={translations}
                    />

                    {/* Macro Form Modal for adding/editing macros */}
                    <MacroFormModal
                        show={showMacroFormModal}
                        onClose={() => setShowMacroFormModal(false)}
                        onSave={handleSaveMacro}
                        macro={editingMacro} // Pass the macro object if editing
                        language={language} // Pass language to modal
                    />

                    {/* Confirmation Modal for deleting macros / resetting keymap */}
                    <ConfirmationModal
                        show={showConfirmationModal}
                        onClose={() => setShowConfirmationModal(false)}
                        onConfirm={confirmResetKeymap} // Use the unified handler
                        message={macroToDeleteId === 'RESET_KEYMAP' ? translations.resetKeymapConfirmation[language] : translations.deleteMacroConfirmation[language]}
                        language={language} // Pass language to modal
                    />

                    {/* Add Shortcut Modal for adding custom shortcuts */}
                    <AddShortcutModal
                        show={showAddShortcutModal}
                        onClose={() => setShowAddShortcutModal(false)}
                        onSave={handleSaveNewShortcut}
                        language={language} // Pass language to modal
                    />
                </div>
            );
        }

        // Render the React App component into the 'root' div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
